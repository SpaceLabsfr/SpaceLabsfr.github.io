<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="common.css">
    <link rel="stylesheet" type="text/css" href="app_content.css">
</head>

<body>

    <h2 class="maintitle">Application de développement Python en programmation par bloc</h2>
    <div class="emplacement" id="origin">
        <div id="13" class="drag" draggable="true" ondragstart="return dragStart(event)">
            <img src="img/Flaticon/001-youtube.png" width="70" height="70" />
        </div>
        <div id="14" class="drag" draggable="true" ondragstart="return dragStart(event)">
            <p class="action">Démarrer</p>
        </div>
        <div id="15" class="drag" draggable="true" ondragstart="return dragStart(event)">
            <p class="action">Tourner à gauche</p>
        </div>
        <div id="16" class="drag" draggable="true" ondragstart="return dragStart(event)">
            <p class="action">Avancer</p>
        </div>
    </div>

    <div class="emplacement" id="trame">
        <div class="bloc" id=1 ondragenter="return dragEnter(event)" ondrop="return dragDrop(event)" ondragover="return dragOver(event)">
            <button class="delete" onclick="reset(1)">X</button>
        </div>
        <div class="bloc" id=2 ondragenter="return dragEnter(event)" ondrop="return dragDrop(event)" ondragover="return dragOver(event)">
            <button class="delete" onclick="reset(2)">X</button>
        </div>
        <div class="bloc" id=3 ondragenter="return dragEnter(event)" ondrop="return dragDrop(event)" ondragover="return dragOver(event)">
            <button class="delete" onclick="reset(3)">X</button>
        </div>
        <div class="bloc" id=4 ondragenter="return dragEnter(event)" ondrop="return dragDrop(event)" ondragover="return dragOver(event)">
            <button class="delete" onclick="reset(4)">X</button>
        </div>
    </div>

    <button class="submit" onclick="generate()">Valider</button>


    <div style="display: flex; justify-content: center;" class="section">
        <div class="big">
            <p class="title">Résultats :</p>
            <p><span id="result">. . .</span></p>

</body>


<script type="text/javascript ">
    // Reset du contenu des emplacements

    function reset(id) {
        console.log(id);
        console.log(document.getElementById(id));
        node = document.getElementById(id);
        if (node.childNodes[2]) {
            node.removeChild(node.childNodes[2]);
            node.removeChild(node.childNodes[2]);
        }
    }

    // Drag & Drop

    function dragStart(ev) {
        ev.dataTransfer.effectAllowed = 'move';
        ev.dataTransfer.setData("Text", ev.target.getAttribute('id'));
        ev.dataTransfer.setData("Origin", ev.target.parentNode.getAttribute('id'))
        ev.dataTransfer.setDragImage(ev.target, 0, 0);
        return true;
    }

    function dragEnter(ev) {
        event.preventDefault();
        return true;
    }

    function dragOver(ev) {
        return false;
    }

    function dragDrop(ev) {

        event.preventDefault();

        var src = ev.dataTransfer.getData("Text");
        var tempo = document.createElement('span');
        tempo.className = 'hide';

        var origin_id = ev.dataTransfer.getData("Origin")

        // On empêche de drop si le parent a un élément qui existe déjà!
        //console.log(ev.target.parentNode.childElementCount)
        console.log(src)
        console.log(origin_id)
        console.log(ev.target.id)
        console.log(ev.target.childElementCount)
        if (ev.target.childElementCount == 1) {
            var copy = document.getElementById(src).cloneNode(true);
            copy.id = copy.id + "-copy";
            // On ne peut plus déplacer un élément copié
            copy.draggable = false;
            copy.ondragstart = false;
            ev.target.appendChild(copy);
        }
        ev.stopPropagation();
        return false;
    }

    // Génération du code Python selon les actions choisies

    function generate() {
        actions_list = [] // liste des actions voulues
        actions = document.getElementById("trame");

        element = document.getElementsByClassName('bloc')
        console.log(element)
        console.log("element.length" + element.length)
        for (var i = 0; i < element.length; i++) {
            console.log(element[i]) // Liste des actions prises

            children = element[i].childNodes;
            console.log(children)
            console.log(children.length)
            for (var j = 0; j < children.length; j++) {
                console.log(children[j].className)
                if (children[j].className == 'drag') {
                    // Succès si le sous-élément a la class "drag"
                    actions_list.push(children[j].id) // Alors on a l'action dans l'ID
                }
            }
        }

        console.log(actions_list);

        output = ""; // Code Python à ressortir
        for (var i = 0; i < actions_list.length; i++) {
            console.log(actions_list[i]);
            switch (actions_list[i]) {
                case "13-copy":
                    output += "Logo Youtube<br/>";
                    break;
                case "14-copy":
                    output += "Je démarre<br/>";
                    break;
                case "15-copy":
                    output += "Je tourne à gauche<br/>";
                    break;
                case "16-copy":
                    output += "J'avance<br/>";
                    break;
            }
        }

        document.getElementById("result").innerHTML = output;
    }
</script>

</html>